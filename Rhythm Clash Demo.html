<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Target–Distractor Task</title>
  <style>
    body {
      margin: 0;
      background: white;
      color: black;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #controls {
      width: 240px;
      /* narrower sidebar */
      position: fixed;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 6px;
      overflow-y: auto;
      max-height: 95vh;
    }

    #controls fieldset {
      border: 1px solid black;
      margin: 6px 0;
      padding: 6px;
    }

    #controls label {
      font-size: 12px;
      display: block;
      margin-top: 4px;
    }

    #controls input,
    #controls select {
      width: 100%;
      font-size: 12px;
      background: white;
      color: black;
      border: 1px solid black;
    }

    #controls button {
      margin-top: 8px;
      width: 100%;
      background: black;
      color: white;
      border: none;
      padding: 6px;
      cursor: pointer;
    }

    #rectangle {
      position: absolute;
      top: 50%;
      left: calc(50% + 100px);
      /* center corrected for sidebar width */
      transform: translate(-50%, -50%);
      background-color: hsl(210, 100%, 50%)
    }
  </style>

</head>

<body>
  <div id="controls">
    <label>Feature pair:
      <select id="versionNum" onchange="updateControls()">
        <option value="1">Size + Color</option>
        <option value="2">Size + Luminance</option>
        <option value="3">Rotation + Color</option>
        <option value="4">Rotation + Luminance</option>
      </select>
    </label>
    <div id="featureControls"></div>
    <button onclick="startStimulus()">Start</button>
  </div>

  <div id="rectangle"></div>

  <script>
    let timers = [];
    const rect = document.getElementById("rectangle");
    const offsetOptions = [-200, -150, -100, -50, 50, 100, 150, 200];

    function clearTimers() {
      timers.forEach(t => clearTimeout(t));
      timers = [];
    }

    // === HELPER FUNCTIONS ===
    function hexToHSL(H) {
      let r = parseInt(H.substr(1, 2), 16);
      let g = parseInt(H.substr(3, 2), 16);
      let b = parseInt(H.substr(5, 2), 16);
      r /= 255; g /= 255; b /= 255;
      let cmin = Math.min(r, g, b), cmax = Math.max(r, g, b), delta = cmax - cmin;
      let h = 0, s = 0, l = 0;
      if (delta === 0) h = 0;
      else if (cmax === r) h = ((g - b) / delta) % 6;
      else if (cmax === g) h = (b - r) / delta + 2;
      else h = (r - g) / delta + 4;
      h = Math.round(h * 60); if (h < 0) h += 360;
      l = (cmax + cmin) / 2;
      s = delta === 0 ? 0 : delta / (1 - Math.abs(2 * l - 1));
      s = +(s * 100).toFixed(1); l = +(l * 100).toFixed(1);
      return { h, s, l };
    }
    function HSLtoCSS(h, s, l) { return `hsl(${h}, ${s}%, ${l}%)`; }

    // === MAIN START ===
    function startStimulus() {
      clearTimers();
      const version = +document.getElementById("versionNum").value;

      // Read UI
      const f1 = document.getElementById("targetFeature").value;
      const f2 = document.getElementById("distractorFeature").value;
      const f1Interval = +document.getElementById("targetInterval").value;
      const f2Mode = document.getElementById("distractorMode").value;
      const f2Interval = +document.getElementById("distractorInterval").value;

      // feature parameters
      const baseWidth = +document.getElementById("baseWidth").value;
      const baseHeight = +document.getElementById("baseHeight").value;
      const baseColor = document.getElementById("baseColor").value;

      const sizeFactor = +document.getElementById("sizeFactor").value;
      const rotationAngle = +document.getElementById("rotationAngle").value;
      const hueShift = +document.getElementById("hueShift").value;
      const lumShift = +document.getElementById("lumShift").value;

      // Reset all states first
      let sizeOn = false, rotOn = false, colorOn = false, lumOn = false;

      rect.style.width = baseWidth + "px";
      rect.style.height = baseHeight + "px";
      rect.style.backgroundColor = baseColor;

      function applyTransform() {
        let scalePart = sizeOn ? `scale(${sizeFactor})` : "scale(1)";
        let rotPart = rotOn ? `rotate(${rotationAngle}deg)` : "rotate(0deg)";
        rect.style.transform = `translate(-50%, -50%) ${scalePart} ${rotPart}`;
      }

      // Initialize to base state - ensure clean start at base size
      applyTransform();

      // Feature toggle functions
      function toggleSize() { sizeOn = !sizeOn; applyTransform(); }
      function toggleRotation() { rotOn = !rotOn; applyTransform(); }
      function toggleColor() {
        colorOn = !colorOn;
        let baseHSL = hexToHSL(baseColor);
        let shifted = HSLtoCSS((baseHSL.h + hueShift) % 360, baseHSL.s, baseHSL.l);
        rect.style.backgroundColor = colorOn ? shifted : baseColor;
      }
      function toggleLuminance() {
        lumOn = !lumOn;
        let baseHSL = hexToHSL(baseColor);
        let flashL = baseHSL.l * (1 - lumShift / 100);
        flashL = Math.min(100, Math.max(0, flashL));
        let shifted = HSLtoCSS(baseHSL.h, baseHSL.s, flashL);
        rect.style.backgroundColor = lumOn ? shifted : baseColor;
      }

      const featureMap = { size: toggleSize, color: toggleColor, luminance: toggleLuminance, rotation: toggleRotation };

      // === Target rhythm generator ===
      function rhythmicLoop(featureFn, interval, distractorFn, distractorMode) {
        function loop() {
          featureFn(); // target
          if (distractorFn) {
            // If both size and color are active, start them simultaneously
            const isSizeColorPair = (f1 === "size" && f2 === "color") || (f1 === "color" && f2 === "size");
            if (isSizeColorPair && distractorMode === "rhythmic") {
              distractorFn(); // Start immediately with target for simultaneous start
            } else if (distractorMode === "rhythmic") {
              timers.push(setTimeout(distractorFn, f2Interval));
            } else if (distractorMode === "random") {
              let offset = offsetOptions[Math.floor(Math.random() * offsetOptions.length)];
              timers.push(setTimeout(distractorFn, interval + offset));
            }
          }
          timers.push(setTimeout(loop, interval));
        }
        // Start after first interval to ensure base state is visible first
        timers.push(setTimeout(loop, interval));
      }

      rhythmicLoop(featureMap[f1], f1Interval, featureMap[f2], f2Mode);
    }

    function updateControls() {
      const version = +document.getElementById("versionNum").value;
      const fc = document.getElementById("featureControls");
      fc.innerHTML = "";

      let features = [];
      if (version === 1) features = ["size", "color"];
      else if (version === 2) features = ["size", "luminance"];
      else if (version === 3) features = ["rotation", "color"];
      else if (version === 4) features = ["rotation", "luminance"];

      fc.innerHTML = `
        <fieldset>
          <legend>Target settings</legend>
          <label>Target feature:
            <select id="targetFeature">
              <option value="${features[0]}">${features[0]}</option>
              <option value="${features[1]}">${features[1]}</option>
            </select>
          </label>
          <label>Target interval (ms):
            <input type="number" id="targetInterval" value="350">
          </label>
        </fieldset>
        <fieldset>
          <legend>Distractor settings</legend>
          <label>Distractor feature:
            <select id="distractorFeature">
              <option value="${features[0]}">${features[0]}</option>
              <option value="${features[1]}" selected>${features[1]}</option>
            </select>
          </label>
          <label>Distractor interval (ms):
            <input type="number" id="distractorInterval" value="400">
          </label>
          <label>Distractor mode:
            <select id="distractorMode">
              <option value="rhythmic">Rhythmic</option>
              <option value="random">Random</option>
            </select>
          </label>
        </fieldset>
        <fieldset>
          <legend>Stimulus base</legend>
          <label>Base width (px): <input type="number" id="baseWidth" value="50"></label>
          <label>Base height (px): <input type="number" id="baseHeight" value="100"></label>
          <label>Base color: <input type="color" id="baseColor" value="#0080FF"></label>
        </fieldset>
        <fieldset>
          <legend>Change magnitudes</legend>
          <label>Size factor: <input type="number" id="sizeFactor" step="0.1" value="1.2"></label>
          <label>Rotation angle (°): <input type="number" id="rotationAngle" value="15"></label>
          <label>Hue shift (°): <input type="number" id="hueShift" value="80"></label>
          <label>Luminance shift (%): <input type="number" id="lumShift" value="25"></label>
        </fieldset>`;
    }

    updateControls();
  </script>
</body>

</html>